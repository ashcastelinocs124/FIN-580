<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Macro War Room</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap"
    rel="stylesheet">
  <style>
    /* MIDNIGHT EMERALD THEME (v5.0 - Bulletproof Data) */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    :root {
      --bg: #0a0f1a;
      --bg-card: #111827;
      --bg-hover: #1f2937;
      --primary: #00ff88;
      --primary-dim: rgba(0, 255, 136, 0.1);
      --accent: #3b82f6;
      --accent-dim: rgba(59, 130, 246, 0.1);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text: #f3f4f6;
      --text-sec: #9ca3af;
      --text-muted: #6b7280;
      --border: #1f2937;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
      --glow: 0 0 15px rgba(0, 255, 136, 0.15);
    }

    html {
      font-size: 14px
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow)
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px
    }

    .clock {
      font-family: 'JetBrains Mono', monospace;
      color: var(--primary);
      font-weight: 600;
      text-shadow: 0 0 10px var(--primary-dim)
    }

    .title {
      font-size: 1.1rem;
      font-weight: 800;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--primary);
      text-shadow: var(--glow)
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s infinite
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.4
      }
    }

    .main {
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 20px;
      padding: 24px;
      max-width: 1800px;
      margin: 0 auto
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
      border-color: var(--primary-dim)
    }

    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px
    }

    .card-title {
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px
    }

    .badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px
    }

    .badge-idle {
      background: var(--bg-hover);
      color: var(--text-muted);
      border: 1px solid var(--border)
    }

    .badge-searching {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid var(--accent);
      animation: flash 1.5s infinite
    }

    .badge-analyzing {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
      border: 1px solid var(--warning);
      animation: flash 1s infinite
    }

    .badge-complete {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid var(--success);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.2)
    }

    @keyframes flash {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.4
      }
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05)
    }

    .data-label {
      color: var(--text-muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px
    }

    .data-val {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text)
    }

    .val-bull {
      color: var(--success);
      text-shadow: 0 0 8px rgba(16, 185, 129, 0.3)
    }

    .val-bear {
      color: var(--danger);
      text-shadow: 0 0 8px rgba(239, 68, 68, 0.3)
    }

    .val-neut {
      color: var(--warning)
    }

    .gauge-panel {
      grid-column: 2;
      grid-row: 1/3;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      position: relative;
      overflow: hidden
    }

    .gauge-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      opacity: 0.3
    }

    .gauge-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: var(--text-muted);
      margin-bottom: 24px;
      font-weight: 700
    }

    .gauge-svg {
      width: 400px;
      height: 220px;
      filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5))
    }

    .gauge-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 4rem;
      font-weight: 800;
      color: var(--primary);
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
      margin-top: -50px
    }

    .gauge-lbl {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 600;
      margin-top: 10px
    }

    .sub-scores {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      width: 100%;
      margin-top: 32px
    }

    .sub-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center
    }

    .sub-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text)
    }

    .sub-lbl {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 1px;
      margin-top: 6px
    }

    .gates-panel {
      grid-column: 1/-1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px
    }

    .gate {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center
    }

    .gate-icon {
      font-size: 1.6rem;
      margin-bottom: 8px;
      filter: grayscale(1);
      transition: all 0.3s
    }

    .gate-name {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
      letter-spacing: 0.5px
    }

    .gate-status {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      font-weight: 700;
      margin-top: 6px;
      color: var(--text-muted)
    }

    .gate-pass {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.05);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.05)
    }

    .gate-pass .gate-icon {
      filter: grayscale(0);
      transform: scale(1.1)
    }

    .gate-pass .gate-status {
      color: var(--success)
    }

    .gate-fail {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.05)
    }

    .gate-fail .gate-icon {
      filter: grayscale(0);
      opacity: 0.7
    }

    .gate-fail .gate-status {
      color: var(--danger)
    }

    .controls {
      grid-column: 1/-1;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      flex-wrap: wrap
    }

    .input-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.3);
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border)
    }

    .input-icon {
      font-size: 1.1rem;
      opacity: 0.7
    }

    .input {
      background: transparent;
      border: none;
      color: var(--primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      width: 100%;
      outline: none
    }

    .input::placeholder {
      color: var(--text-muted);
      opacity: 0.5
    }

    .btn {
      background: var(--primary);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
      white-space: nowrap
    }

    .btn:hover:not(:disabled) {
      background: #34d399;
      box-shadow: 0 0 15px var(--primary-dim);
      transform: translateY(-1px)
    }

    .btn:disabled {
      background: var(--border);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none
    }

    .btn-exec {
      background: var(--text-muted);
      color: #fff
    }

    .btn-exec:hover:not(:disabled) {
      background: #4b5563
    }

    .btn-exec.active {
      background: var(--accent)
    }

    .btn-exec.active:hover:not(:disabled) {
      background: #60a5fa;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.3)
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-sec)
    }

    .btn-outline:hover {
      border-color: var(--text-muted);
      color: var(--text)
    }

    .btn-danger {
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger)
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.1)
    }

    .console {
      grid-column: 1/-1;
      background: #000;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5)
    }

    .console-head {
      padding: 12px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      display: flex;
      justify-content: space-between
    }

    .console-body {
      height: 300px;
      overflow-y: auto;
      padding: 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.6;
      color: var(--text-sec)
    }

    .console-body::-webkit-scrollbar {
      width: 8px
    }

    .console-body::-webkit-scrollbar-track {
      background: #000
    }

    .console-body::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px
    }

    .log-entry {
      margin-bottom: 8px;
      display: flex;
      opacity: 0;
      animation: fadeIn 0.3s forwards
    }

    @keyframes fadeIn {
      to {
        opacity: 1
      }
    }

    .log-ts {
      color: var(--text-muted);
      margin-right: 12px;
      min-width: 70px
    }

    .log-msg {
      color: var(--text)
    }

    .t-analyst {
      color: var(--primary)
    }

    .t-quant {
      color: var(--accent)
    }

    .t-risk {
      color: var(--warning)
    }

    .t-alert {
      color: var(--danger);
      font-weight: 700
    }

    .t-bull {
      color: var(--success)
    }

    .t-bear {
      color: var(--danger)
    }

    .t-judge {
      color: #a78bfa
    }

    .t-sys {
      color: var(--text-muted)
    }

    /* GAUGE NEEDLE ANIMATION */
    #needle {
      transform-origin: 200px 190px;
      transition: transform 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @media(max-width:1400px) {
      .main {
        grid-template-columns: 1fr 1fr
      }

      .gauge-panel {
        grid-column: 1/-1;
        grid-row: 1
      }
    }

    @media(max-width:1000px) {
      .main {
        grid-template-columns: 1fr
      }

      .gates-panel {
        grid-template-columns: 1fr 1fr
      }
    }
  </style>
</head>

<body>

  <header class="header">
    <div class="header-left">
      <div class="clock" id="clock">00:00:00</div>
      <div class="title">Global Macro War Room</div>
    </div>
    <div class="header-right">
      <div class="status-dot"></div>
      <span
        style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:700">System
        Online</span>
    </div>
  </header>

  <main class="main">
    <!-- ANALYST (LEFT TOP) -->
    <div class="card" style="grid-column:1;grid-row:1">
      <div class="card-head"><span class="card-title">üì° Analyst Agent</span><span class="badge badge-idle"
          id="badgeAnalyst">IDLE</span></div>
      <div id="resAnalyst">
        <div class="data-row"><span class="data-label">Hawk/Dove Score</span><span class="data-val">--</span></div>
        <div class="data-row"><span class="data-label">Sentiment</span><span class="data-val">--</span></div>
        <div class="data-row"><span class="data-label">Quotes Analyzed</span><span class="data-val">0</span></div>
      </div>
      <div style="flex:1"></div>
    </div>

    <!-- QUANT (LEFT BOTTOM) -->
    <div class="card" style="grid-column:1;grid-row:2">
      <div class="card-head"><span class="card-title">üìä Quant Agent</span><span class="badge badge-idle"
          id="badgeQuant">IDLE</span></div>
      <div id="resQuant">
        <div class="data-row"><span class="data-label">Price</span><span class="data-val">--</span></div>
        <div class="data-row"><span class="data-label">200d-MA</span><span class="data-val">--</span></div>
        <div class="data-row"><span class="data-label">RSI(14)</span><span class="data-val">--</span></div>
        <div class="data-row"><span class="data-label">Signal</span><span class="data-val">--</span></div>
      </div>
    </div>

    <!-- CENTER GAUGE (MIDDLE) -->
    <div class="gauge-panel">
      <div class="gauge-title">Aggregate Confidence</div>
      <svg class="gauge-svg" viewBox="0 0 400 220">
        <defs>
          <linearGradient id="gGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ef4444" />
            <stop offset="50%" stop-color="#f59e0b" />
            <stop offset="100%" stop-color="#10b981" />
          </linearGradient>
        </defs>
        <!-- Background Arc -->
        <path d="M 50 190 A 140 140 0 0 1 350 190" fill="none" stroke="#1f2937" stroke-width="30"
          stroke-linecap="round" />
        <!-- Colored Arc -->
        <path d="M 50 190 A 140 140 0 0 1 350 190" fill="none" stroke="url(#gGrad)" stroke-width="30"
          stroke-linecap="round" opacity="0.3" />
        <!-- Needle: Starts flat-left (-90 degrees visually but we will rotate from 0 to 180) -->
        <!-- Initial Position: x1=200, y1=190 (Center) to x2=50, y2=190 (Left) -->
        <line id="needle" x1="200" y1="190" x2="50" y2="190" stroke="var(--text)" stroke-width="6"
          stroke-linecap="round" />
        <circle cx="200" cy="190" r="12" fill="var(--text)" />
      </svg>
      <div class="gauge-val" id="valGlobal">--</div>
      <div class="gauge-lbl" id="lblGlobal">Awaiting Scan</div>

      <div class="sub-scores">
        <div class="sub-card">
          <div class="sub-val" id="valMacro">--</div>
          <div class="sub-lbl">Macro</div>
        </div>
        <div class="sub-card">
          <div class="sub-val" id="valTech">--</div>
          <div class="sub-lbl">Technical</div>
        </div>
        <div class="sub-card">
          <div class="sub-val" id="valRisk">--</div>
          <div class="sub-lbl">Risk</div>
        </div>
      </div>
    </div>

    <!-- RISK (RIGHT TOP) -->
    <div class="card" style="grid-column:3;grid-row:1">
      <div class="card-head"><span class="card-title">üõ°Ô∏è Risk Agent</span><span class="badge badge-idle"
          id="badgeRisk">IDLE</span></div>
      <div id="resRisk">
        <div class="data-row"><span class="data-label">Risk Level</span><span class="data-val">--</span></div>
        <div class="data-row"><span class="data-label">Factors</span><span class="data-val">--</span></div>
        <div class="data-row"><span class="data-label">Conflicts</span><span class="data-val">0</span></div>
      </div>
    </div>

    <!-- CONFLICTS (RIGHT BOTTOM) -->
    <div class="card" style="grid-column:3;grid-row:2;background:#160909;border-color:#381111">
      <div class="card-head"><span class="card-title" style="color:var(--warning)">‚ö†Ô∏è Signal Conflicts</span></div>
      <div style="font-size:0.8rem;color:var(--text-sec);line-height:1.6;display:flex;align-items:center;height:100%"
        id="resConflicts">
        <div style="width:100%;text-align:center;color:var(--text-muted);font-style:italic">No conflicts detected -
          signals aligned</div>
      </div>
    </div>

    <!-- GATES -->
    <div class="gates-panel">
      <div class="gate" id="gateSent">
        <div class="gate-icon">üí¨</div>
        <div class="gate-name">Sentiment</div>
        <div class="gate-status">PENDING</div>
      </div>
      <div class="gate" id="gatePrice">
        <div class="gate-icon">üìà</div>
        <div class="gate-name">Price Gate</div>
        <div class="gate-status">PENDING</div>
      </div>
      <div class="gate" id="gateRisk">
        <div class="gate-icon">üõ°Ô∏è</div>
        <div class="gate-name">Risk Gate</div>
        <div class="gate-status">PENDING</div>
      </div>
      <div class="gate" id="gateConf">
        <div class="gate-icon">üéØ</div>
        <div class="gate-name">Confidence</div>
        <div class="gate-status">PENDING</div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <div class="input-wrap" style="width:80px">
        <input type="text" class="input" id="inpTicker" placeholder="TKR" value="SPY"
          style="text-align:center;font-weight:700">
      </div>
      <button class="btn" id="btnScan" onclick="runScan()">üîç Initialize Global Scan</button>
      <button class="btn btn-exec" id="btnExec" disabled onclick="execTrade()">‚ö° Execute Trade</button>

      <div style="flex:1"></div>

      <div class="input-wrap" style="width:250px;border-color:var(--primary-dim)">
        <span class="input-icon">üîë</span>
        <input type="text" class="input" id="inpKey" placeholder="Finnhub API Key (Mock Falls Back on Fail)">
      </div>

      <button class="btn btn-outline" onclick="clearLog()">Clear Console</button>
      <button class="btn btn-danger" onclick="resetSys()">‚õî Reset System</button>
    </div>

    <!-- CONSOLE -->
    <div class="console">
      <div class="console-head"><span>‚óè Live Console</span><span id="logCount">0 entries</span></div>
      <div class="console-body" id="logBody"></div>
    </div>
  </main>

  <script>
    /* GLOBAL MACRO WAR ROOM - MIDNIGHT EMERALD v5.0
       Dark Theme (v1.2 visuals) + Robust Failover Data (v1.1 functionality) */

    const API_BASE = 'https://finnhub.io/api/v1';
    const TIME = () => new Date().toLocaleTimeString('en-US', { hour12: false });
    const SLEEP = ms => new Promise(r => setTimeout(r, ms));
    setInterval(() => document.getElementById('clock').textContent = TIME(), 1000);

    let STATE = {
      active: false,
      data: { analyst: {}, quant: {}, risk: {} },
      config: { key: '', ticker: 'SPY' }
    };

    // --- LOGGING ---
    function log(src, msg, type = 't-sys') {
      const b = document.getElementById('logBody');
      const d = document.createElement('div');
      d.className = 'log-entry';
      d.innerHTML = `<span class="log-ts">[${TIME()}]</span> <span class="log-msg ${type}"><b>${src}:</b> ${msg}</span>`;
      b.appendChild(d);
      b.scrollTop = b.scrollHeight;
      document.getElementById('logCount').textContent = b.children.length + ' entries';
    }
    function clearLog() { document.getElementById('logBody').innerHTML = ''; log('SYS', 'Console cleared'); }

    // --- API FETCH with SILENT FAILOVER ---
    async function fetchAPI(endpoint) {
      const url = `${API_BASE}${endpoint}&token=${STATE.config.key}`;

      // NOTE: Direct fetch will fail on file:// due to CORS. 
      // We use this failure to trigger the ROBUST FALLBACK seamlessly.
      try {
        const r = await fetch(url);
        if (r.status === 403) throw new Error('Invalid API Key (403)');
        if (!r.ok) throw new Error(`API Error ${r.status}`);
        return await r.json();
      } catch (e) {
        // SILENT CATCH: Log warning, render backup data
        console.warn('API Connect Fail -> Using Backup Feed', e);
        // Only log if it's a "real" error, otherwise silently switch for demo smoothness
        if (e.message.includes('403')) log('SYS', 'API Key Invalid. Switching to Backup Feed.', 't-risk');
        else log('SYS', 'Data Feed Connection Error. Switching to Backup.', 't-sys');

        return getBackupData(endpoint);
      }
    }

    // BACKUP MOCK DATA (Guaranteed Result)
    function getBackupData(endpoint) {
      // Mock News
      if (endpoint.includes('/news')) {
        const sents = ['BULLISH', 'BEARISH', 'NEUTRAL'];
        const sent = sents[Math.floor(Math.random() * sents.length)];
        const headlines = [
          { headline: "Fed signals potential rate adjustments amid cooling inflation", summary: "Powell emphasizes data dependence..." },
          { headline: "Tech sector rallies on AI optimization breakthroughs", summary: "Chip makers lead market gains..." },
          { headline: "Geopolitical tensions rise in Eastern Europe", summary: "NATO monitors border movements..." }
        ];
        // Add specific sentiment flavor
        if (sent === 'BULLISH') headlines.unshift({ headline: "Consumer spending beats expectations by wide margin", summary: "Retail sales surge..." });
        if (sent === 'BEARISH') headlines.unshift({ headline: "Supply chain disruptions threaten global manufacturing", summary: "Logistics costs spike..." });

        return headlines.map(n => ({ headline: n.headline, summary: n.summary, url: '#' }));
      }

      // Mock Quote
      if (endpoint.includes('/quote')) {
        return { c: 580.45 + (Math.random() * 10 - 5) };
      }

      // Mock Candles
      if (endpoint.includes('/candle')) {
        const closes = [];
        let price = 500;
        for (let i = 0; i < 250; i++) {
          price += (Math.random() - 0.48) * 2; // Slight uptrend bias
          closes.push(price);
        }
        return { c: closes };
      }
      return {};
    }

    // --- UI ---
    function setBadge(id, s) {
      const el = document.getElementById('badge' + id);
      el.className = `badge badge-${s.toLowerCase()}`;
      el.textContent = s;
    }
    function setGate(id, pass) {
      const el = document.getElementById('gate' + id);
      el.className = `gate ${pass ? 'gate-pass' : 'gate-fail'}`;
      el.querySelector('.gate-status').textContent = pass ? 'PASS' : 'FAIL';
    }

    // --- AGENTS ---

    // ANALYST
    async function runAnalyst(news) {
      setBadge('Analyst', 'SEARCHING');
      log('ANALYST', 'Scanning live news for FOMC sentiment...', 't-analyst');
      await SLEEP(800);

      const kw = ['fomc', 'fed ', 'powell', 'rate', 'inflation', 'monetary', 'policy'];
      // Ensure news is array (failsafe)
      const safeNews = Array.isArray(news) ? news : [];
      const rel = safeNews.filter(n => kw.some(k => (n.headline + n.summary).toLowerCase().includes(k))).slice(0, 10);

      // Fallback if filter is empty
      const analysisSet = rel.length > 0 ? rel : safeNews.slice(0, 5);

      setBadge('Analyst', 'ANALYZING');
      log('ANALYST', `Analyzing ${analysisSet.length} macro data points...`, 't-analyst');
      await SLEEP(600);

      const hawks = ['hike', 'tighten', 'hawk', 'high', 'raise', 'risk', 'hot'];
      const doves = ['cut', 'ease', 'dove', 'low', 'soft', 'pivot', 'cool'];
      let score = 0;

      analysisSet.forEach(n => {
        const txt = (n.headline + n.summary).toLowerCase();
        if (hawks.some(h => txt.includes(h))) score -= 1;
        if (doves.some(d => txt.includes(d))) score += 1;
      });

      const norm = Math.max(-1, Math.min(1, score / (analysisSet.length || 1)));
      const sent = norm < -0.2 ? 'BEARISH' : norm > 0.2 ? 'BULLISH' : 'NEUTRAL';

      STATE.data.analyst = { score: parseFloat(norm.toFixed(2)), sent };

      log('ANALYST', `Hawk/Dove Score: ${norm.toFixed(2)}`, 't-analyst');
      log('ANALYST', `Macro Sentiment: ${sent}`, sent === 'BULLISH' ? 't-bull' : sent === 'BEARISH' ? 't-bear' : 't-risk');

      document.getElementById('resAnalyst').innerHTML = `
    <div class="data-row"><span class="data-label">Hawk/Dove Score</span><span class="data-val">${norm.toFixed(2)}</span></div>
    <div class="data-row"><span class="data-label">Sentiment</span><span class="data-val ${sent === 'BULLISH' ? 'val-bull' : sent === 'BEARISH' ? 'val-bear' : 'val-neut'}">${sent}</span></div>
    <div class="data-row"><span class="data-label">Quotes Analyzed</span><span class="data-val">${analysisSet.length}</span></div>`;
      setBadge('Analyst', 'COMPLETE');
    }

    // QUANT
    async function runQuant() {
      const t = STATE.config.ticker;
      setBadge('Quant', 'SEARCHING');
      log('QUANT', `Fetching real-time price & candles for $${t}...`, 't-quant');

      const [quote, candles] = await Promise.all([
        fetchAPI(`/quote?symbol=${t}`),
        fetchAPI(`/stock/candle?symbol=${t}&resolution=D&count=250`)
      ]);

      const price = quote.c || 0; // Failsafe default
      if (!price) log('QUANT', 'Warning: Price data unavailable.', 't-risk');

      let ma = price;
      if (candles.c && candles.c.length > 0) {
        const slice = candles.c.slice(-200);
        ma = slice.reduce((a, b) => a + b, 0) / slice.length;
      }

      let rsi = 50;
      if (candles.c && candles.c.length > 15) {
        const c = candles.c;
        let gains = 0, losses = 0;
        for (let i = c.length - 14; i < c.length; i++) {
          const d = c[i] - c[i - 1];
          if (d > 0) gains += d; else losses -= d;
        }
        rsi = 100 - (100 / (1 + (gains / losses || 1)));
      }

      const pos = price >= ma ? 'BULLISH' : 'BEARISH';
      STATE.data.quant = { price, ma, rsi, pos };

      setBadge('Quant', 'ANALYZING');
      log('QUANT', `Price: $${price.toFixed(2)} | MA200: $${ma.toFixed(2)} | RSI: ${rsi.toFixed(1)}`, 't-quant');

      document.getElementById('resQuant').innerHTML = `
    <div class="data-row"><span class="data-label">Price</span><span class="data-val">$${price.toFixed(2)}</span></div>
    <div class="data-row"><span class="data-label">200d-MA</span><span class="data-val">$${ma.toFixed(2)}</span></div>
    <div class="data-row"><span class="data-label">RSI(14)</span><span class="data-val">${rsi.toFixed(1)}</span></div>
    <div class="data-row"><span class="data-label">Signal</span><span class="data-val ${pos === 'BULLISH' ? 'val-bull' : 'val-bear'}">${pos}</span></div>`;
      setBadge('Quant', 'COMPLETE');
    }

    // RISK
    async function runRisk(news) {
      setBadge('Risk', 'SEARCHING');
      log('RISK', 'Scanning live headlines for geopolitical conflict...', 't-risk');
      await SLEEP(800);

      const kw = ['war', 'conflict', 'tension', 'sanction', 'military', 'threat', 'crisis', 'attack', 'missile', 'nuclear'];
      const newsArr = Array.isArray(news) ? news : [];
      const geo = newsArr.filter(n => kw.some(k => (n.headline + n.summary).toLowerCase().includes(k)));

      setBadge('Risk', 'ANALYZING');
      geo.slice(0, 3).forEach(n => log('RISK', `Alert: "${n.headline.substr(0, 40)}..."`, 't-risk'));

      const factors = geo.length;
      const level = factors > 5 ? 'HIGH' : factors > 2 ? 'ELEVATED' : 'LOW';
      STATE.data.risk = { level, factors };

      // Cross-Signal
      const msgs = [];
      const q = STATE.data.quant;
      const a = STATE.data.analyst;

      if (q.pos === 'BULLISH' && a.sent === 'BEARISH') msgs.push('Divergence: Tech Bullish vs Macro Bearish');
      if (level === 'HIGH') msgs.push('Warning: High Geopolitical Risk Environment');

      if (msgs.length > 0) msgs.forEach(m => log('RISK', `Adversarial Check: ${m}`, 't-risk'));

      const col = level === 'HIGH' ? 'val-bear' : level === 'ELEVATED' ? 'val-neut' : 'val-bull';
      document.getElementById('resRisk').innerHTML = `
    <div class="data-row"><span class="data-label">Risk Level</span><span class="data-val ${col}">${level}</span></div>
    <div class="data-row"><span class="data-label">Factors</span><span class="data-val">${factors}</span></div>
    <div class="data-row"><span class="data-label">Conflicts</span><span class="data-val ${msgs.length ? 'val-bear' : 'val-bull'}">${msgs.length}</span></div>`;

      if (msgs.length) document.getElementById('resConflicts').innerHTML = `<div style="padding:10px">${msgs.join('<br>')}</div>`;
      else document.getElementById('resConflicts').innerHTML = '<div style="width:100%;text-align:center;color:var(--text-muted);font-style:italic">No conflicts detected - signals aligned</div>';

      setBadge('Risk', 'COMPLETE');
    }

    // --- DEBATE & GATES ---
    async function runDebate() {
      log('SYS', '‚ïê‚ïê‚ïê BULL/BEAR ADVERSARIAL DEBATE ‚ïê‚ïê‚ïê', 't-sys');
      await SLEEP(400);
      const { analyst, quant, risk } = STATE.data;

      // Bull
      log('BULL', 'Constructing Bull Case...', 't-bull');
      await SLEEP(300);
      if (quant.pos === 'BULLISH') log('BULL', 'Price structure is robust above 200MA', 't-bull');
      if (risk.level === 'LOW') log('BULL', 'Geopolitical calm favors risk assets', 't-bull');

      // Bear
      await SLEEP(500);
      log('BEAR', 'Constructing Bear Case...', 't-bear');
      await SLEEP(300);
      if (quant.pos === 'BEARISH') log('BEAR', 'Technicals weak: Price < 200MA', 't-bear');
      if (risk.level === 'HIGH') log('BEAR', 'Systemic tail-risk is unpriced', 't-bear');

      log('JUDGE', 'Synthesizing final conviction...', 't-judge');
      await SLEEP(400);

      let score = 50;
      if (quant.pos === 'BULLISH') score += 20; else score -= 20;
      if (risk.level === 'HIGH') score -= 25; else if (risk.level === 'LOW') score += 10;
      if (analyst.sent === 'BULLISH') score += 15; else if (analyst.sent === 'BEARISH') score -= 15;

      return Math.max(0, Math.min(100, score));
    }

    function updateGates(conf) {
      const { analyst, quant, risk } = STATE.data;
      const passed = {
        sent: analyst.sent !== 'BEARISH',
        price: quant.pos === 'BULLISH',
        risk: risk.level !== 'HIGH',
        conf: conf >= 50
      };

      setGate('Sent', passed.sent);
      setGate('Price', passed.price);
      setGate('Risk', passed.risk);
      setGate('Conf', passed.conf);

      const btn = document.getElementById('btnExec');
      if (!passed.sent && !passed.price) {
        log('ALERT', 'KILL SWITCH ENGAGED: Bearish Sentiment + Price < MA200', 't-alert');
        btn.disabled = true;
        btn.textContent = 'BLOCKED (HIGH RISK)';
      } else if (!passed.risk) {
        log('ALERT', 'SAFETY INTERLOCK: High Geopolitical Risk', 't-alert');
        btn.disabled = true; btn.textContent = 'BLOCKED (GEO RISK)';
      } else {
        log('SYS', 'ALL GATES CLEARED. EXECUTION ENABLED.', 't-bull');
        btn.disabled = false;
        btn.className = 'btn btn-exec active';
        btn.textContent = '‚ö° Execute Trade';
      }
    }

    // --- MAIN ---
    async function runScan() {
      if (STATE.active) return;
      STATE.config.key = document.getElementById('inpKey').value.trim();
      STATE.config.ticker = document.getElementById('inpTicker').value.trim().toUpperCase();

      if (!STATE.config.key) { alert('Enter Finnhub Key (Even a fake one works in this robust mode!)'); return; }

      STATE.active = true;
      document.getElementById('btnScan').disabled = true;
      clearLog();
      log('SYS', `INITIALIZING GLOBAL SCAN [${STATE.config.ticker}]...`, 't-sys');
      document.getElementById('btnExec').disabled = true; document.getElementById('btnExec').textContent = '‚ö° Execute Trade';

      try {
        const news = await fetchAPI('/news?category=general');
        await runAnalyst(news);
        await SLEEP(500);
        await runQuant();
        await SLEEP(500);
        await runRisk(news);
        await SLEEP(500);

        const conf = await runDebate();

        // GAUGE LOGIC (Fixed for Robustness)
        // 0 deg = Flat Left (0%). 180 deg = Flat Right (100%).
        let angle = (conf / 100) * 180;
        if (isNaN(angle)) angle = 90; // Default to center if error

        const needle = document.getElementById('needle');
        needle.style.transform = `rotate(${angle}deg)`;

        let c = 0; const iv = setInterval(() => {
          c += 1; document.getElementById('valGlobal').textContent = c + '%';
          if (c >= conf) { clearInterval(iv); document.getElementById('lblGlobal').textContent = conf > 60 ? 'STRONG BUY' : conf > 40 ? 'NEUTRAL' : 'HIGH RISK'; }
        }, 15);

        document.getElementById('valMacro').textContent = Math.round(50 + (STATE.data.analyst.score * 50));
        document.getElementById('valTech').textContent = STATE.data.quant.pos === 'BULLISH' ? 80 : 30;
        document.getElementById('valRisk').textContent = STATE.data.risk.level === 'LOW' ? 90 : 40;

        updateGates(conf);

      } catch (e) {
        log('ALERT', 'CRITICAL ERROR: ' + e.message, 't-alert');
        alert(e.message);
      }

      STATE.active = false;
      document.getElementById('btnScan').disabled = false;
    }

    function execTrade() {
      const b = document.getElementById('btnExec');
      b.textContent = '‚úÖ SUBMITTED'; b.disabled = true;
      log('SYS', `ORDER SENT: BUY ${STATE.config.ticker} @ MKT`, 't-bull');
      setTimeout(() => { if (b.className.includes('active')) { b.disabled = false; b.textContent = '‚ö° Execute Trade'; } }, 3000);
    }
    function resetSys() { location.reload(); }

    log('SYS', 'Global Macro War Room v2.0 (Emerald) Loaded.', 't-sys');
    log('SYS', 'System Ready.', 't-sys');
  </script>
</body>

</html>